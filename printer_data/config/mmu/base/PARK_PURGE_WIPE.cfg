# ====================================================================================
# PURGE, PARK, AND WIPE MACROS FOR HAPPY HARE MMU
# ====================================================================================
# Based on Blobifier: https://github.com/moggieuk/Happy-Hare/blob/main/config/addons/blobifier.cfg

[gcode_macro PURGE_VARIABLES]
description: Configuration variables for purge, park, and wipe operations

# Purge settings
variable_purge_spd:              6.67   # Speed of purge in mm/s
variable_purge_temp_min:         200    # Minimum nozzle temperature for purging
variable_purge_length_minimum:   30     # Minimum purge length (mm) even if tool didn't change
variable_purge_length_maximum:   80     # Maximum filament per blob (mm)
variable_purge_length:           40     # Default purge length (mm)
variable_purge_length_modifier:  1      # Multiplier for slicer purge volumes (0.6-1.0 recommended)
variable_purge_length_addition:  0      # Fixed additional purge length (mm)
variable_pressure_release_time:  1000   # Dwell time (ms) after purging before cleaning

# Park position settings
variable_purge_x:                86     # X position of purge location
variable_purge_y:                287.5  # Y position of purge location
variable_purge_x_entry:          86     # X entry position before purge location
variable_purge_y_entry:          270    # Y entry position before purge location
variable_z_min:                  20     # Minimum Z height during park
variable_z_lift:                 0      # Z hop amount during park moves

# Movement speed settings (mm/s)
variable_travel_speed:           300      # Travel speed for park movements
variable_entry_speed:            50   # Speed when entering purge location
variable_travel_spd_xy:          300    # Travel speed for wipe movements (XY)
variable_travel_spd_z:           10  # Travel speed for Z movements
variable_wipe_spd_xy:            300    # Wipe speed during brush cleaning

# Wipe/brush settings
variable_wipe_qty:               2      # Number of complete wipe cycles
variable_final_wipe_count:       3      # Number of back/forth wipes along X axis after circular pattern
variable_brush_accel:            12000  # Acceleration during brush operations
variable_brush_y_position:       280    # Y position of brush center
variable_brush_start:            164    # X start position of brush
variable_brush_width:            23     # Brush width (mm)
variable_brush_depth:            6      # Brush depth in Y direction (mm)

# Fan settings (0.0-1.0)
variable_part_fan_name:          "part_fan"  # Name of the part cooling fan
variable_purge_fan_speed:        0.4    # Part cooling fan speed during purge
variable_wipe_fan_speed:         0.8    # Part cooling fan speed during wipe
variable_part_cooling_fan:       1      # Fan speed during blob formation (1=full, 0=off, -1=unchanged)

gcode: # Leave blank


# ====================================================================================
# MAIN PURGE MACRO
# ====================================================================================
[gcode_macro BUCKET_PURGE]
gcode:
    {% set vars = printer['gcode_macro PURGE_VARIABLES'] %}
    
    SAVE_GCODE_STATE NAME=BUCKET_PURGE_state
    
    # Check homing status
    {% if "xyz" not in printer.toolhead.homed_axes %}
        RESPOND MSG="PURGE: Not homed! Home XYZ before purging"
    {% else %}
        # Set feedrate to 100% for correct purging
        {% set backup_feedrate = printer.gcode_move.speed_factor %}
        M220 S100
        
        # Define variables
        {% set sequence_vars = printer['gcode_macro _MMU_SEQUENCE_VARS'] %}
        {% set park_vars = printer['gcode_macro _MMU_PARK'] %}
        {% set filament_diameter = printer.configfile.config.extruder.filament_diameter|float %}
        {% set filament_cross_section = (filament_diameter/2) ** 2 * 3.1415 %}
        {% set from_tool = printer.mmu.last_tool %}
        {% set to_tool = printer.mmu.tool %}
        {% set backup_fan_speed = printer["fan_generic " ~ vars.part_fan_name].speed %}
        {% set pv = printer.mmu.slicer_tool_map.purge_volumes %}
        
        # Determine purge length
        {% if params.PURGE_LENGTH %}
            {action_respond_info("PURGE: Using provided PURGE_LENGTH")}
            {% set purge_len = params.PURGE_LENGTH|float %}
        {% elif from_tool == to_tool and to_tool >= 0 %}
            {action_respond_info("PURGE: Tool didn't change (T%s > T%s), %s" % (from_tool, to_tool, "priming" if vars.purge_length_minimum else "skipping"))}
            {% set purge_len = 0 %}
        {% elif pv %}
            {% if from_tool < 0 and to_tool >= 0 %}
                {action_respond_info("PURGE: From tool unknown. Finding largest value for T? > T%d" % to_tool)}
                {% set purge_vol = pv|map(attribute=to_tool)|max %}
            {% elif to_tool < 0 %}
                {action_respond_info("PURGE: Tool(s) unknown. Finding largest value")}
                {% set purge_vol = pv|map('max')|max %}
            {% else %}
                {% set purge_vol = pv[from_tool][to_tool]|float * vars.purge_length_modifier %}
                {action_respond_info("PURGE: Swapped T%s > T%s" % (from_tool, to_tool))}
            {% endif %}
            {% set purge_len = purge_vol / filament_cross_section %}
            {% set purge_len = purge_len + printer.mmu.extruder_filament_remaining + park_vars.retracted_length + vars.purge_length_addition %}
        {% else %}
            {action_respond_info("PURGE: No toolmap or PURGE_LENGTH. Using default")}
            {% set purge_len = vars.purge_length|float + printer.mmu.extruder_filament_remaining + park_vars.retracted_length %}
        {% endif %}
        
        # Apply minimum purge length
        {% if purge_len < vars.purge_length_minimum %}
            {action_respond_info("PURGE: Purge length too short, using minimum")}
        {% endif %}
        {% set purge_len = [purge_len, vars.purge_length_minimum]|max|round(0, 'ceil')|int %}
        {action_respond_info("PURGE: Purging %dmm of filament" % (purge_len))}
        
        {% if purge_len|float > 0 %}
            # Move to park position if needed
            {% if not (printer.toolhead.position.x == vars.purge_x and printer.toolhead.position.y == vars.purge_y) %}
                PURGE_PARK
            {% endif %}
            
            # Heat hotend if needed
            {% if printer.extruder.temperature < vars.purge_temp_min - 2 %}
                RESPOND MSG="PURGE: Heating extruder to minimum temperature"
                {% if printer.extruder.target < vars.purge_temp_min %}
                    M109 S{vars.purge_temp_min}
                {% else %}
                    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={vars.purge_temp_min}
                {% endif %}
            {% endif %}
            
            # Calculate purge parameters
            {% set blobs = (purge_len / vars.purge_length_maximum)|round(0, 'ceil')|int %}
            {% set purge_per_blob = purge_len|float / blobs %}
            {% set retracts_per_blob = (purge_per_blob / 40)|round(0, 'ceil')|int %}
            {% set pulses_per_retract = (purge_per_blob / retracts_per_blob / 5)|round(0, 'ceil')|int %}
            {% set pulses_per_blob = (purge_per_blob / 5)|round(0, 'ceil')|int %}
            {% set purge_per_pulse = purge_per_blob / pulses_per_blob %}
            
            # Purge in blobs
            {% for blob in range(blobs) %}
                RESPOND MSG={"'PURGE: Blob %d of %d (%.1fmm)'" % (blob + 1, blobs, purge_per_blob)}
                
                G91  # Relative positioning
                M83  # Relative extrusion
                
                # Purge filament in pulsating motion
                {% for pulse in range(pulses_per_blob) %}
                    {% set speed = vars.purge_spd * 60 %}
                    G1 E{purge_per_pulse * 0.95} F{speed}
                    G1 E{purge_per_pulse * 0.05} F{speed}
                    
                    # Periodic retraction for thorough cleaning
                    {% if pulse % pulses_per_retract == 0 and pulse > 0 %}
                        G1 E-2 F1800
                        G1 E2 F800
                    {% endif %}
                {% endfor %}
                
                # Retract to match Happy Hare expectations
                G1 E-{park_vars.retracted_length} F{sequence_vars.retract_speed * 60}
                
                # Deposit blob with shaking motion
                G4 P{vars.pressure_release_time}
                G90
                G1 X115 F5000
                G1 X100 F5000
                G1 X115 F5000
                G1 X100 F5000
                G1 X115 F5000
                G1 X85 F5000
            {% endfor %}
        {% endif %}
        
        # Restore feedrate and state
        M220 S{(backup_feedrate * 100)|int}
        G90
        G1 X125 F15000  # Kick debris away
        SET_FAN_SPEED FAN={vars.part_fan_name} SPEED={backup_fan_speed}
    {% endif %}
    
    RESTORE_GCODE_STATE NAME=BUCKET_PURGE_state MOVE=0


# ====================================================================================
# BRUSH WIPE MACRO
# ====================================================================================
[gcode_macro PURGE_WIPE]
gcode:
    {% set vars = printer['gcode_macro PURGE_VARIABLES'] %}
    {% set backup_fan_speed = printer["fan_generic " ~ vars.part_fan_name].speed %}
    
    SAVE_GCODE_STATE NAME=PURGE_WIPE_state
    
    G90
    G1 Z10
    
    # Set brush acceleration if configured
    {% if vars.brush_accel > 0 %}
        SET_VELOCITY_LIMIT ACCEL={vars.brush_accel} MINIMUM_CRUISE_RATIO=0.1
    {% endif %}
    
    SET_FAN_SPEED FAN={vars.part_fan_name} SPEED={vars.wipe_fan_speed}
    
    # Move to randomized brush start position
    G1 Y280 F8000
    G1 X164 F8000
    {% set random_y_start = range((vars.brush_y_position - vars.brush_depth/2)|int, (vars.brush_y_position + vars.brush_depth/2)|int)|random %}
    G1 X{vars.brush_start} Y{random_y_start} F{vars.travel_spd_xy * 60}
    G1 Z-1 F900
    
    # Perform wipe cycles
    {% for wipes in range(1, (vars.wipe_qty + 1)) %}
        # Full width straight wipe
        {% set random_y = range(vars.brush_y_position|int, (vars.brush_y_position + vars.brush_depth)|int)|random %}
        G1 X{vars.brush_start + vars.brush_width} Y{random_y} F{vars.wipe_spd_xy * 60}
        G1 X{vars.brush_start} F{vars.wipe_spd_xy * 60}
        
        # Circular pattern (clockwise)
        {% set center_x = vars.brush_start + vars.brush_width / 2 %}
        {% set center_y = vars.brush_y_position + vars.brush_depth / 2 %}
        {% set radius_x = vars.brush_width / 2 %}
        {% set radius_y = vars.brush_depth / 2 %}
        {% set circular_speed = vars.wipe_spd_xy * 30 %}
        G1 X{center_x + radius_x} Y{center_y} F{circular_speed}
        G1 X{center_x} Y{center_y + radius_y} F{circular_speed}
        G1 X{center_x - radius_x} Y{center_y} F{circular_speed}
        G1 X{center_x} Y{center_y - radius_y} F{circular_speed}
        G1 X{center_x + radius_x} Y{center_y} F{circular_speed}
        
        # Back and forth wipe along X axis at brush center
        {% for final_wipe in range(vars.final_wipe_count) %}
            G1 X{vars.brush_start} Y{center_y} F{vars.wipe_spd_xy * 60}
            G1 X{vars.brush_start + vars.brush_width} Y{center_y} F{vars.wipe_spd_xy * 60}
        {% endfor %}
    {% endfor %}
    
    G1 Z10 F900
    SET_FAN_SPEED FAN={vars.part_fan_name} SPEED={backup_fan_speed}
    RESTORE_GCODE_STATE NAME=PURGE_WIPE_state


# ====================================================================================
# PARK NOZZLE AT PURGE LOCATION
# ====================================================================================
[gcode_macro PURGE_PARK]
description: Park nozzle at purge location to prevent oozing during filament swaps
gcode:
    {% set vars = printer["gcode_macro PURGE_VARIABLES"] %}
    {% set Px = vars.purge_x|float %}
    {% set Py = vars.purge_y|float %}
    {% set Pxe = vars.purge_x_entry|float %}
    {% set Pye = vars.purge_y_entry|float %}
    {% set St = vars.travel_speed * 60 %}
    {% set Se = vars.entry_speed * 60 %}
    {% set max_z = printer.configfile.config.stepper_z.position_max|float %}
    {% set cur_z = printer.gcode_move.gcode_position.z|float %}
    {% set z_min = vars.z_min|float %}
    {% set z_lift = vars.z_lift|float %}
    
    SAVE_GCODE_STATE NAME=PURGE_PARK_state
    
    {% if not (printer.toolhead.position.x == Px and printer.toolhead.position.y == Py) %}
        {% set z_safe = [[cur_z + z_lift, z_min]|max, max_z]|min %}
        
        G90
        G1 Z{z_safe} F{St}
        G1 Y{Pye} F{St}
        G1 X{Pxe} F{St}
        G4 P1000
        G1 X{Px} Y{Py} F{Se}
    {% endif %}
    
    RESTORE_GCODE_STATE NAME=PURGE_PARK_state MOVE=0


# ====================================================================================
# EXIT PARK POSITION
# ====================================================================================
[gcode_macro EXIT_PARK]
description: Exit from purge park position
gcode:
    {% set vars = printer["gcode_macro PURGE_VARIABLES"] %}
    {% set Px = vars.purge_x|float %}
    {% set Py = vars.purge_y|float %}
    {% set Pxe = vars.purge_x_entry|float %}
    {% set Pye = vars.purge_y_entry|float %}
    {% set St = vars.travel_speed * 60 %}
    {% set Se = vars.entry_speed * 60 %}
    {% set cur_z = printer.gcode_move.gcode_position.z|float %}
    {% set z_min = vars.z_min|float %}
    
    G90
    
    # Ensure minimum Z height
    {% if cur_z < z_min %}
        G1 Z{z_min} F{St}
    {% endif %}
    
    # Move to entry position
    {% if not (printer.toolhead.position.x == Px and printer.toolhead.position.y == Py) %}
        G1 X{Px} Y{Py} F{Se}
    {% endif %}
    G1 X{Pxe} Y{Pye} F{Se}


# ====================================================================================
# MAIN PURGE COMMAND
# ====================================================================================
[gcode_macro PURGE]
description: Execute complete purge sequence with exit
gcode:
    BUCKET_PURGE
    EXIT_PARK