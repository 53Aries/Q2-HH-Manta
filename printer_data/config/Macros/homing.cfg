
[gcode_macro _Sensorless_Homing_Variables]
description: Variables for sensorless homing

# Printer dimensions
variable_max_x_position: 270.0      # Maximum X axis position (mm)
variable_max_y_position: 270.0      # Maximum Y axis position (mm)
variable_max_z_position: 260.0      # Maximum Z axis position (mm)

# Homing behavior
variable_z_hop_distance: 10         # Distance (mm) to move Z axis prior to homing
variable_first_homed_axis: 'Y'      # First axis to home when 'G28' is called ('X' or 'Y')

# Safe Z homing position
variable_safe_z_enable: True        # Enable moving printhead before homing Z axis
variable_safe_x: -128               # Safe X position to home Z axis (-128 = center of X axis)
variable_safe_y: -128               # Safe Y position to home Z axis (-128 = center of Y axis)

# Movement speeds (mm/s)
variable_xy_move_speed: 200         # Speed for XY moves during homing
variable_z_probe_travel_speed: 10   # Speed for Z moves after probe (F2000)
variable_xy_backoff_speed: 20       # Speed for backing off after X/Y homing (F3000)
variable_xy_backoff_distance: 20    # Distance (mm) to back off from endstop after homing

# Sensorless homing current
variable_homing_current: 1.0        # TMC current during sensorless homing

# Z homing settings
variable_z_homing_temp: 150         # Nozzle temperature during Z homing (prevents filament sticking)
variable_z_probe_randomize: 10      # Randomization range (+/-) for Z probe position (mm)

gcode:

[homing_override]
axes: xyz
gcode:
    {% set home_all = 'X' not in params and 'Y' not in params and 'Z' not in params %}
    {% set vars = printer["gcode_macro _Sensorless_Homing_Variables"] %}
    {% set z_hop_speed = (printer.configfile.settings['stepper_z'].homing_speed * 60)|float %}
    {% set travel_speed = (vars.xy_move_speed * 60)|float %}
    {% set z_hop_distance = vars.z_hop_distance|float %}
    {% set first_homed_axis = vars.first_homed_axis|string %}
    {% set safe_x = vars.safe_x|float %}
    {% set safe_y = vars.safe_y|float %}
    {% set safe_z = vars.safe_z_enable|abs %}
    
    # Calculate safe X/Y positions (use center if -128)
    {% if safe_x == -128 %}
        {% set safe_x = vars.max_x_position / 2 %}
    {% endif %}
    {% if safe_y == -128 %}
        {% set safe_y = vars.max_y_position / 2 %}
    {% endif %}
    
    # Z hop if needed
    {% if z_hop_distance > 0 %}
        {% if 'x' not in printer.toolhead.homed_axes and 'y' not in printer.toolhead.homed_axes %}
            SET_KINEMATIC_POSITION Z=0
            G0 Z{z_hop_distance} F{z_hop_speed}
        {% endif %}
    {% endif %}
    
    # Home X and Y in configured order
    {% if first_homed_axis == 'X' %}
        {% if home_all or 'X' in params %}
            _HOME_X
        {% endif %}
        {% if home_all or 'Y' in params %}
            _HOME_Y
        {% endif %}
    {% endif %}
    
    {% if first_homed_axis == 'Y' %}
        {% if home_all or 'Y' in params %}
            _HOME_Y
        {% endif %}
        {% if home_all or 'X' in params %}
            _HOME_X
        {% endif %}
    {% endif %}
    
    # Rehome XY for redundancy if doing full home or both axes requested
    {% if (home_all or ('X' in params and 'Y' in params)) %}
        _HOME_XY
    {% endif %}
    
    # Move to safe position before Z homing
    {% if safe_z == 1 and (('Z' in params) or home_all) and ('Z' not in printer.toolhead.homed_axes) %}
        # Ensure Z is at safe height before moving XY
        {% if 'z' in printer.toolhead.homed_axes %}
            {% if printer.toolhead.position.z < z_hop_distance %}
                G1 Z{z_hop_distance} F{z_hop_speed}
            {% endif %}
        {% endif %}
        G0 X{safe_x} Y{safe_y} F{travel_speed}
    {% endif %}
    
    # Home Z axis
    {% if home_all or 'Z' in params %}
        # Save heater temperatures and fan speeds
        {% set extruder_target = printer.extruder.target|default(0) %}
        {% set bed_target = printer.heater_bed.target|default(0) %}
        {% set chamber_target = printer['heater_generic chamber'].target|default(0) %}
        {% set mmu_target = printer['heater_generic heater_mmu'].target|default(0) %}
        {% set part_fan_speed = printer['fan_generic part_fan'].speed|default(0) %}
        {% set aux_fan_speed = printer['fan_generic auxiliary_cooling_fan'].speed|default(0) %}
        {% set chamber_fan_speed = printer['fan_generic chamber_circulation_fan'].speed|default(0) %}
        
        G90
        M106 S255  # Turn on part cooling fan to help cool down nozzle
        M109 S{vars.z_homing_temp}  # Heat/cool nozzle to prevent filament sticking
        TURN_OFF_HEATERS  # Turn off all heaters to eliminate load cell noise
        SET_FAN_SPEED FAN=part_fan SPEED=0
        SET_FAN_SPEED FAN=auxiliary_cooling_fan SPEED=0
        SET_FAN_SPEED FAN=chamber_circulation_fan SPEED=0
        SET_STEPPER_ENABLE STEPPER=extruder ENABLE=0
        
        # Randomize probe point
        {% set base_x = vars.max_x_position / 2|float %}
        {% set base_y = vars.max_y_position / 2|float %}
        {% set safe_x = range((base_x - vars.z_probe_randomize)|int, (base_x + vars.z_probe_randomize)|int + 1)|random %}
        {% set safe_y = range((base_y - vars.z_probe_randomize)|int, (base_y + vars.z_probe_randomize)|int + 1)|random %}
        G0 X{safe_x} Y{safe_y} F{travel_speed}
        G4 P1000
        _HOME_Z
        G1 Z10 F{vars.z_probe_travel_speed * 60}
        
        # Restore heater temperatures
        SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={bed_target}
        SET_HEATER_TEMPERATURE HEATER=extruder TARGET={extruder_target}
        {% if chamber_target > 0 %}
            SET_HEATER_TEMPERATURE HEATER=chamber TARGET={chamber_target}
        {% endif %}
        {% if mmu_target > 0 %}
            SET_HEATER_TEMPERATURE HEATER=heater_mmu TARGET={mmu_target}
        {% endif %}
        
        # Restore fan speeds
        SET_FAN_SPEED FAN=part_fan SPEED={part_fan_speed}
        SET_FAN_SPEED FAN=auxiliary_cooling_fan SPEED={aux_fan_speed}
        SET_FAN_SPEED FAN=chamber_circulation_fan SPEED={chamber_fan_speed}
    {% endif %}

[gcode_macro _HOME_XY]
description: Home both axes twice for redundancy, respecting first_homed_axis order
gcode:
    {% set vars = printer["gcode_macro _Sensorless_Homing_Variables"] %}
    {% set first_axis = vars.first_homed_axis|string %}
    
    {% if first_axis == 'Y' %}
        _HOME_Y
        _HOME_X
    {% else %}
        _HOME_X
        _HOME_Y
    {% endif %}

[gcode_macro _HOME_X]
description: Home X axis using sensorless homing
gcode:
    {% set vars = printer["gcode_macro _Sensorless_Homing_Variables"] %}
    {% set run_current = printer.configfile.settings['tmc5160 stepper_x'].run_current %}
    
    # Reduce current for sensorless homing
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={vars.homing_current}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={vars.homing_current}
    G4 P2000
    
    # Home X axis
    G28 X
    
    # Restore run current
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={run_current}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={run_current}
    
    # Back off from endstop
    G91
    G1 X-{vars.xy_backoff_distance} F{vars.xy_backoff_speed * 60}
    G90

[gcode_macro _HOME_Y]
description: Home Y axis using sensorless homing
gcode:
    {% set vars = printer["gcode_macro _Sensorless_Homing_Variables"] %}
    {% set run_current = printer.configfile.settings['tmc5160 stepper_y'].run_current %}
    
    # Reduce current for sensorless homing
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={vars.homing_current}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={vars.homing_current}
    G4 P2000
    
    # Home Y axis
    G28 Y
    
    # Restore run current
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={run_current}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={run_current}
    
    # Back off from endstop
    G91
    G1 Y{vars.xy_backoff_distance} F{vars.xy_backoff_speed * 60}
    G90

[gcode_macro LOAD_CELL_HOMING_VARS]
description: Variables for probing Z with load cell
variable_initial_probe_speed: 3        # Initial probe speed (mm/s) for general area
variable_initial_probe_samples: 1      # Number of samples for initial probe
variable_z_lift_speed: 5               # Speed for Z lifts between probes (mm/s)
variable_z_lift_between_probes: 2      # Z lift distance between probes (mm)
variable_z_final_height: 10            # Final Z height after homing (mm)
gcode:

[gcode_macro _HOME_Z]
description: Home Z axis using load cell probe
gcode:
    {% set vars = printer['gcode_macro LOAD_CELL_HOMING_VARS'] %}
    {% set initial_speed = vars.initial_probe_speed %}
    {% set initial_samples = vars.initial_probe_samples %}
    {% set z_lift_speed = (vars.z_lift_speed * 60)|int %}
    
    SET_GCODE_OFFSET Z=0
    SET_KINEMATIC_POSITION Z=260
    G90
    
    # Initial probe
    LOAD_CELL_TARE
    PROBE PROBE_SPEED={initial_speed} SAMPLES={initial_samples}
    _HOME_Z_FROM_LAST_PROBE
    
    # Lift and probe again at standard speed for accuracy
    G91
    G1 Z{vars.z_lift_between_probes} F{z_lift_speed}
    G90
    LOAD_CELL_TARE
    PROBE
    _HOME_Z_FROM_LAST_PROBE
    
    # Lift to final clearance height
    G1 Z{vars.z_final_height} F{z_lift_speed}

[gcode_macro _HOME_Z_FROM_LAST_PROBE]
description: Set Z position based on last probe result
gcode:
    {% set z_probed = printer.probe.last_z_result %}
    {% set z_position = printer.toolhead.position[2] %}
    {% set z_actual = z_position - z_probed %}
    SET_KINEMATIC_POSITION Z={z_actual}